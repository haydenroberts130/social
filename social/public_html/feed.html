<!DOCTYPE html>
<html lang="en">

<head>
    <title>Your Feed</title>
    <link rel="stylesheet" href="./css/feed.css" />
    <script src="client.js" defer></script>
</head>

<body>
    <div id="topContainer">
      <div id="header">
        <span id="accTop">
          <h1 id="displayName">Placeholder Name</h1>
        </span>
      </div>
      <script>
        const getUsername = () => {
          return fetch("/get/usernameFromCookie").then((response) => {
            if (!response.ok) {
              throw new Error("Failed to fetch username");
            }
            return response.text();
          });
        };

        getUsername()
          .then((username) => {
            document.getElementById(
              "displayName"
            ).innerHTML = `<span style="color: gray;">@</span><a href="account.html?username=${username}" class="username" style="text-decoration: underline;">${username}</a>'s feed`;
          })
          .catch((error) => {
            console.error("Error:", error.message);
          });
      </script>
      <div id="sideBar">
        <input id="sAccounts" type="text" name="sAccounts" />
        <input
          type="submit"
          value="Search Users"
          name="searchAccounts"
          onclick="searchAccounts"
        />
      </div>
      <div id="rightSideBar">
        <input
          type="submit"
          value="+"
          id="postButton"
          class="styled-button"
          onclick="goToPost()"
        />
        <input
          type="submit"
          value="Logout"
          id="logoutButton"
          class="styled-button"
          onclick="logout()"
        />
        <input
          type="submit"
          value="Help"
          id="helpButton"
          class="styled-button"
          onclick="goToHelp()"
        />
      </div>
    </div>
    <div id="displayArea"></div>
    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        const feedContainer = document.getElementById("displayArea");

        try {
          const username = await getUsername();

          if (!username) {
            console.error("Failed to get username");
            return;
          }

          // Make a request to your server to get the following list
          const responseFollowing = await fetch(
            `/get/getFollowingList?username=${username}`
          );
          const followingList = await responseFollowing.json();

          if (followingList.length === 0) {
            // Display a message if the user is not following anyone
            feedContainer.innerHTML =
              "<h1 class='empty-feed-message'>Follow people to see their posts here!</h1>";
          } else {
            // Display posts from the user's follow list
            for (const followedUser of followingList) {
              // Make a request to your server to get posts for each followed user
              const responsePosts = await fetch(
                `/get/getPostsFromUser?username=${followedUser}`
              );
              const posts = await responsePosts.json();

              for (const post of posts) {
                console.log("POST: " + JSON.stringify(post));
                const postDiv = document.createElement("div");
                // console.log("Post = " + post);
                postDiv.classList.add("post");

                const postUsernameDiv = document.createElement("div");
                postUsernameDiv.textContent = post.user;

                const postImageDiv = document.createElement("div");
                postImageDiv.classList.add("post-image");

                const postImage = document.createElement("img");
                postImage.src = `./${post.image}`;
                postImage.alt = post.caption;

                postImageDiv.appendChild(postImage);

                const hrDiv = document.createElement("hr");

                const postContentDiv = document.createElement("div");
                postContentDiv.classList.add("post-content");
                const captionSpan = document.createElement("span");
                captionSpan.textContent = post.caption;

                const likeButton = document.createElement("button");

                // Set button attributes
                likeButton.id = `like_count_${post._id}`;
                likeButton.style.fontSize = "20px";
                likeButton.classList.add("styled-button");
                if (post.likes == null) {
                  likeButton.textContent = "❤ 0";
                } else {
                  likeButton.textContent = "❤ " + post.likes;
                }
                likeButton.addEventListener("click", function () {
                  likePost(post._id);
                });

                postContentDiv.appendChild(captionSpan);
                postContentDiv.appendChild(likeButton);

                postDiv.appendChild(postUsernameDiv);
                postDiv.appendChild(postImageDiv);
                postDiv.appendChild(hrDiv);
                postDiv.appendChild(postContentDiv);

                feedContainer.appendChild(postDiv);
              }
            }
          }
        } catch (error) {
          console.error(error);
        }
      });
    </script>
  </body>
</html>
